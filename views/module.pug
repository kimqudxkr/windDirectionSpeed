extends layout

block content
  link(rel='stylesheet', href='/stylesheets/module.css')
 
  script.
    document.getElementById("module").className="current";

    //- 페이지네이션 동작
    jQuery('document').ready(function() {
      pagination();
      jQuery('.pagination li:first-child').addClass("disabled");

      searchFilter();
    });

    //- 삭제 버튼을 눌러 모듈 정보를 삭제하는 함수
    const deleteModule = (deviceId) => {
      if(confirm("삭제하시겠습니까?")) {
        $.ajax({
          data: {
            'deviceId': deviceId
          },
          type: 'get',
          dataType : 'html',
          url: "/module/api/delete", 
          contentType: 'application/json', 
          success: (success) => {
            alert('삭제완료');
            location.reload();
          },
          error: (err) => {
            alert('삭제실패');
            console.log(err)
          }
        })
      }
    }

    //- 테이블의 데이터를 한번에 6개씩 보여주는 pagination 함수
    const pagination = () => {
      const rowNum = 6;      //- 한 페이지에 보여줄 데이터 갯수
      let $tr = jQuery('tbody tr');
      const totalRowNum = $tr.length;
      let pagesNum = 0;

      //- 총 만들 페이지 갯수 계산
      if(totalRowNum % rowNum == 0) {
        pagesNum = totalRowNum / rowNum;
      }
      else if(totalRowNum % rowNum > 0) {
        pagesNum = totalRowNum / rowNum;
        pagesNum++;
        pagesNum = Math.floor(pagesNum++);
      }

      //- 나눈 갯수만큼 페이지 버튼 생성
      for(let i=1; i<=pagesNum; i++) {
        jQuery('.pagination').append(`<li><button class="btn-dark">${i}</button></li>`);
        jQuery('.pagination button').addClass("pagination-link");
      }

      $tr.each(function(i) {
        jQuery(this).hide();

        if(i+1 <= rowNum) {
          $tr.eq(i).show();
        }
      });

      //- 첫 페이지 선택을 표시하기 위해 버튼의 클래스 제거 -> 흰색 버튼 됨
      jQuery('.pagination li:nth-child(1)').children(":first").removeClass("btn-dark");

      //- pagination의 페이지 버튼을 클릭할 때 작동하는 함수
      jQuery('.pagination button').click('.pagination-link', function(e) {
        e.preventDefault();
        $tr.hide();
        let page = jQuery(this).text();
        let tmp = page - 1;
        let start = tmp * rowNum;
        let currentLink = tmp;

        //- 해당 페이지 확인 중을 표시하기 위해 선택된 버튼의 클래스를 제거하여 흰색으로 표시
        jQuery('.pagination button').addClass("btn-dark");
        jQuery(this).removeClass("btn-dark");

        for(let i=0; i<rowNum; i++) {
          $tr.eq(start+i).show();
        }
      });
    }
    
    //- 검색창의 왼쪽 필터 작동 함수
    const searchFilter = () => {
      $('.search-panel .dropdown-menu').find('a').click(function(e) {
        e.preventDefault();
        var param = $(this).attr("href").replace("#","");
        var concept = $(this).text();

        //- 선택한 필터는 hidden input인 search_param의 value가 됨
        $('.search-panel span#search_concept').text(concept);
        $('.input-group #search_param').val(param);
      });
    }
    
    //- 검색 버튼을 눌렀을 때 작동하는 함수
    const searchModule = () => {
      const column = $('.input-group #search_param').val();
      const matching = $('.input-group .form-control').val();

      if(column=="") {
        alert("필터를 설정해 주세요.");
      } else if(matching=="") {
        alert("검색어를 입력해 주세요.")
      } else {
        alert(`${column}조건으로 ${matching}을 검색합니다.`);

        $.ajax({
          data: {
            'column': column,
            'matching': matching,
          },
          type: 'get',
          dataType : 'html',
          url: "/module/api/moduleSearch", 
          contentType: 'application/json', 
          success: (result) => {
            console.log(result);
            $("#listTable > tbody").html(result);
            jQuery('.pagination *').remove();
            pagination();
          },
          error: (err) => {
            console.log(err)
          }
        })
      }
      
    }

  p#title(style="margin-top:3%;") 장치 목록 

  div.container 
    div.row
      div.col-6.offset-3
        div.input-group
          div.input-group-btn.search-panel
            div.dropdown
              button.btn.btn-btn-default.dropdown-toggle(type="button" data-toggle="dropdown")
                span#search_concept Filter by
                span#caret
              ul.dropdown-menu
                li.dropdown-item 
                  a(href="deviceId") 장치이름
                li.dropdown-divider
                li.dropdown-item 
                  a(href="deviceType") 장치유형
                li.dropdown-divider
                li.dropdown-item 
                  a(href="location") 장치위치
                li.dropdown-divider
                li.dropdown-item 
                  a(href="rgstDt") 등록일자
          
          input#search_param(type="hidden" name="serch-param")
          input.form-control(type="text" name="x" placeholder="검색 내용을 입력하세요.")
          button.btn.btn-dark(type="button" onClick="searchModule()") search
            
  br
  table#listTable(border='1')
    thead
      tr
        th 장치 이름
        th 장치 유형
        th 장치 위치
        th 등록 일자
        th 수정
        th 삭제
    tbody
     each list in moduleList
      tr
        td #{list.deviceId}
        td #{list.deviceType}
        td #{list.location}
        td #{list.rgstDt}
        td
          button.btn.btn-dark(class='form-control' onClick=`location.href='/modifyModule?deviceId=${list.deviceId}'`) 수정
        td
          button.btn.btn-dark(class='form-control' onClick=`deleteModule('${list.deviceId}')`) 삭제
  br
  ul(class='pagination')
  div
    button.btn.btn-dark(onclick="location.href='/registModule'" style='margin-left: 5px') 새 장치 등록